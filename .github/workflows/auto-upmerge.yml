name: Auto Upmerge

on:
  pull_request_target:
    types: [closed]
    branches:
      - "candidate-*"

jobs:
  auto-upmerge:
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write        # Required for pushing to branches
      pull-requests: write   # Required for posting PR comments
    steps:
      - name: "Debug Info"
        env:
          PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          PULL_REQUEST_TITLE: ${{ github.event.pull_request.title }}
          PULL_REQUEST_AUTHOR: ${{ github.event.pull_request.user.login }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          MERGE_COMMIT_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          echo "Pull Request Number: $PULL_REQUEST_NUMBER"
          echo "Pull Request Title: $PULL_REQUEST_TITLE"
          echo "Pull Request Author: $PULL_REQUEST_AUTHOR"
          echo "Base Branch: $BASE_BRANCH"
          echo "Merge Commit SHA: $MERGE_COMMIT_SHA"

      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.8"

      - name: "Install Dependencies"
        run: |
          set -xe
          python -VV
          python -m site
          python -m pip install --upgrade pip setuptools wheel

      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Configure Git User"
        run: |
          git config user.name "HPCC4J Bot"
          git config user.email "support@hpccsystems.com"

      - name: "Perform Upmerge"
        env:
          PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          PULL_REQUEST_TITLE: ${{ github.event.pull_request.title }}
          PULL_REQUEST_AUTHOR: ${{ github.event.pull_request.user.login }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          MERGE_COMMIT_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROJECT_CONFIG: ${{ vars.PROJECT_CONFIG }}
        run: |
          python .github/workflows/scripts/auto-upmerge.py

      - name: "Upload Upmerge Results"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: upmerge-results-pr-${{ github.event.pull_request.number }}
          path: |
            upmerge-results.json
            upmerge-summary.txt
            upmerge-conflicts.md
          if-no-files-found: ignore
          retention-days: 30

      - name: "Post Comment on Failure"
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        shell: python
        run: |
          import os
          import json
          import subprocess
          from pathlib import Path
          
          pr_number = os.environ['PR_NUMBER']
          
          # Try to load results if they exist
          results_file = Path('upmerge-results.json')
          if results_file.exists():
              with open(results_file, 'r') as f:
                  results = json.load(f)
              
              failed_branches = results.get('failed_upmerges', [])
              successful_branches = results.get('successful_upmerges', [])
              detailed_results = results.get('detailed_results', [])
              
              comment = "## üîÑ Auto-Upmerge Results\n\n"
              comment += "**Status**: ‚ö†Ô∏è Some upmerges failed\n\n"
              
              if successful_branches:
                  comment += f"### ‚úÖ Successful Upmerges ({len(successful_branches)})\n\n"
                  for branch in successful_branches:
                      comment += f"- `{branch}`\n"
                  comment += "\n"
              
              if failed_branches:
                  comment += f"### ‚ùå Failed Upmerges ({len(failed_branches)})\n\n"
                  
                  # Group by conflict vs other failures
                  conflict_branches = []
                  other_failures = []
                  
                  for detail in detailed_results:
                      if detail['target_branch'] in failed_branches:
                          if detail.get('status') == 'conflicts':
                              conflict_branches.append(detail)
                          else:
                              other_failures.append(detail)
                  
                  # Show conflict-related failures with details
                  if conflict_branches:
                      comment += "#### Conflicts Detected\n\n"
                      for detail in conflict_branches:
                          branch = detail['target_branch']
                          conflict_check = detail.get('conflict_check', {})
                          conflicted_files = conflict_check.get('conflicted_files', [])
                          
                          comment += f"**`{branch}`** - {len(conflicted_files)} file(s) with conflicts\n"
                          if conflicted_files:
                              comment += "<details><summary>View conflicted files</summary>\n\n"
                              for filepath in conflicted_files[:20]:
                                  comment += f"- `{filepath}`\n"
                              if len(conflicted_files) > 20:
                                  comment += f"- ... and {len(conflicted_files) - 20} more\n"
                              comment += "\n</details>\n\n"
                  
                  # Show other failures
                  if other_failures:
                      comment += "#### Other Failures\n\n"
                      for detail in other_failures:
                          branch = detail['target_branch']
                          error = detail.get('error', 'Unknown error')
                          comment += f"- **`{branch}`**: {error[:100]}\n"
                      comment += "\n"
                  
                  # Fallback: list any failed branches not covered above
                  uncovered_failures = set(failed_branches) - {d['target_branch'] for d in conflict_branches + other_failures}
                  if uncovered_failures:
                      comment += "#### Other Failed Branches\n\n"
                      for branch in uncovered_failures:
                          comment += f"- `{branch}`\n"
                      comment += "\n"
                  
                  comment += "**Action Required**: These branches need manual upmerging.\n"
                  comment += "\nüì• Download the workflow artifacts for detailed conflict information.\n"
              
              comment += "\n*This comment was automatically generated by the auto-upmerge workflow.*"
          else:
              comment = "## üîÑ Auto-Upmerge Results\n\n"
              comment += "**Status**: ‚ùå Upmerge process failed\n\n"
              comment += "The auto-upmerge workflow encountered an error. Please check the workflow logs for details.\n\n"
              comment += "*This comment was automatically generated by the auto-upmerge workflow.*"
          
          # Post comment
          comments_url = f'https://api.github.com/repos/{os.environ["GITHUB_REPOSITORY"]}/issues/{pr_number}/comments'
          comment_json = json.dumps(comment)
          
          subprocess.run([
              'curl', '-X', 'POST', comments_url,
              '-H', 'Content-Type: application/json',
              '-H', f'Authorization: token {os.environ["GITHUB_TOKEN"]}',
              '--data', f'{{"body": {comment_json}}}'
          ], check=True)

      - name: "Post Success Comment"
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        shell: python
        run: |
          import os
          import json
          import subprocess
          from pathlib import Path
          
          pr_number = os.environ['PR_NUMBER']
          
          # Load results
          results_file = Path('upmerge-results.json')
          if results_file.exists():
              with open(results_file, 'r') as f:
                  results = json.load(f)
              
              successful_branches = results.get('successful_upmerges', [])
              
              comment = "## üîÑ Auto-Upmerge Results\n\n"
              comment += "**Status**: ‚úÖ All upmerges successful\n\n"
              
              if successful_branches:
                  comment += f"### Upmerged Branches ({len(successful_branches)})\n\n"
                  for branch in successful_branches:
                      comment += f"- `{branch}`\n"
              
              comment += "\n*This comment was automatically generated by the auto-upmerge workflow.*"
              
              # Post comment
              comments_url = f'https://api.github.com/repos/{os.environ["GITHUB_REPOSITORY"]}/issues/{pr_number}/comments'
              comment_json = json.dumps(comment)
              
              subprocess.run([
                  'curl', '-X', 'POST', comments_url,
                  '-H', 'Content-Type: application/json',
                  '-H', f'Authorization: token {os.environ["GITHUB_TOKEN"]}',
                  '--data', f'{{"body": {comment_json}}}'
              ], check=True)
